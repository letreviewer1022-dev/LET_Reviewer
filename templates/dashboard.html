{% macro include_attempt_history(attempts_list) %}
    {% if attempts_list %}
        <div class="question-grid" id="attempt-history-grid">
            {% for a in attempts_list %}
            {# Assuming 'a' is an Attempt object from the database #}
            <div class="question-card attempt-card">
                
                <div class="card-header">
                    <span class="card-id">Attempt #{{ loop.revindex }}</span>
                    <span class="card-subject">{{ a.subject|upper if a.subject else 'N/A' }}</span>
                </div>

                <div class="card-body">
                    
                    <p class="question-attempt-text">
                        <strong>Date Taken:</strong> 
                        {{ a.date_taken|localize_time }}
                    </p>
                    
                    <p class="question-attempt-text">
                        <strong>Score:</strong> 
                        <span class="attempt-score">
                            {{ "%.0f"|format(a.score) }} / {{ "%.0f"|format(a.max_score) }}
                        </span>
                    </p>
                    
                    <p class="question-attempt-text">
                        <strong>Time Spent:</strong> 
                        <span>{{ a.duration_seconds|format_duration }}</span>
                    </p>

                </div>

            </div>
            {% endfor %}
        </div>
    {% else %}
        <p class="no-attempts">No quiz attempts recorded yet. Start your first quiz now!</p>
    {% endif %}
{% endmacro %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LET TLE Reviewer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Roboto:wght@400&display=swap" rel="stylesheet">
</head>
<body>
    <nav class="navbar">
        <div class="nav-left">
            <a href="{{ url_for('index') }}"><img src="{{ url_for('static', filename='images/logo.png') }}" class="logo" alt="Logo"></a>
        </div>

        <button class="hamburger" id="hamburger">â˜°</button>

        <ul class="nav-center" id="nav-menu">
            <li><a href="{{ url_for('index') }}">Home</a></li>
            <li><a href="{{ url_for('quiz') }}">Quiz</a></li>
            <li><a href="{{ url_for('mock') }}">Mock Exam</a></li>
        </ul>

        <div class="nav-right">
            {% if 'username' in session %}
                
                {% if session.get('is_admin') %}
                    <a href="{{ url_for('admin_dashboard') }}"><img src="{{ url_for('static', filename='images/dashboard.png') }}" class="login-btn-img"></a>
                {% else %}
                    <a href="{{ url_for('dashboard') }}"><img src="{{ url_for('static', filename='images/dashboard.png') }}" class="login-btn-img"></a>
                {% endif %}
                
            {% else %}
                <a href="{{ url_for('login') }}" class="login-btn">Login</a>
            {% endif %}
        </div>
    </nav>
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        
        <div id="flash-popup-overlay" class="popup-overlay">
            
            <div class="popup-content" onclick="event.stopPropagation();">
                {% for category, message in messages %}
                    
                    <div class="alert alert-{{ category }}" role="alert">
                        
                        {{ message }}
                        
                        <button type="button" class="close-btn" aria-label="Close" 
                                onclick="closeFlashPopup();">
                            &times;
                        </button>
                    </div>

                {% endfor %}
            </div>
            
        </div>

        <script>
            function closeFlashPopup() {
                const overlay = document.getElementById('flash-popup-overlay');
                if (overlay) {
                    overlay.style.display = 'none';
                }
            }
        </script>

    {% endif %}
{% endwith %}

<div class="dashboard-container">
        
        <div class="user-sidebar">
            
            <div class="profile-section">
                <img src="{{ url_for('static', filename='images/admin_profile.png') }}" alt="User Profile Picture" class="profile-pic">
                {% if current_user %}
                    <span class="user-name">{{ current_user.username }}</span>
                {% else %}
                    <span class="user-name">Guest User</span>
                {% endif %}
            </div>
                <p>
                    Logged in as: {{ current_user.username }}
                </p>
                <p>
                    Major: {{ current_user.major }}
                </p>
            <div class="flex-grow"></div> 
            <a href="{{ url_for('logout') }}" class="logout-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-log-out"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                Logout
            </a>

        </div>

        <div class="content-area">
            <header class="main-header">
                <h1>Welcome to the Dashboard!</h1>
                <p>Content is displayed in this light area.</p>
            </header>
            
            <section class="dashboard-widgets">
                <h2>Your Recent Attempts </h2>
                <div style="height: 400px; background: #fff; border-radius: 8px; padding: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.05);">
                    {{ include_attempt_history(attempts) }}
                </div>
            </section>

        </div>

    </div>
    <script>
        const hamburger = document.getElementById('hamburger');
        const navMenu = document.getElementById('nav-menu');

        hamburger.addEventListener('click', () => {
            navMenu.classList.toggle('active');
        });

        document.getElementById('quizButton').addEventListener('click', function() {
            window.location.href = "{{ url_for('quiz') }}";
        });

        document.getElementById('mockButton').addEventListener('click', function() {
            window.location.href = "{{ url_for('mock') }}";
        });
    </script>
</body>
</html>